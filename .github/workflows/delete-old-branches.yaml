name: Delete old scratch branches
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
jobs:
  delete-scratch-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Delete scratch/* branches older than 35 days
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const maxAgeDays = 35; // age threshold
            const cutoff = new Date(Date.now() - maxAgeDays*24*60*60*1000);
            console.log(`Cutoff date: ${cutoff.toISOString()}`);
            // List all non-protected branches
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              protected: false,
              per_page: 100,
            });
            for (const branch of branches.data) {
              const branchName = branch.name;
              // Only delete branches under scratch/*
              if (!branchName.startsWith('scratch/')) continue;
              // Never delete default branch
              if (branchName === context.repo.default_branch) continue;
              // Get last commit for the branch
              const commit = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: branchName,
              });
              const commitDate = new Date(commit.data.commit.author.date);
              if (commitDate < cutoff) {
                core.info(`Deleting branch ${branchName} (last commit ${commitDate.toISOString()})`);
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${branchName}`,
                });
              }
            }
