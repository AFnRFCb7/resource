name: Close old PRs
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
permissions:
  pull-requests: write
jobs:
  close-old-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Close PRs older than 35 days
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const maxAgeDays = 35; // age threshold
            const cutoff = new Date(Date.now() - maxAgeDays*24*60*60*1000);

            // List all open PRs
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            for (const pr of prs.data) {
              const createdAt = new Date(pr.created_at);
              if (createdAt < cutoff) {
                core.info(`Closing PR #${pr.number} (created at ${pr.created_at})`);
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  state: 'closed',
                });
              }
            }
